import os
import streamlit as st
from openai import OpenAI
from docx import Document
from io import BytesIO
import fitz  # PyMuPDF

# --- –ù–ê–°–¢–†–û–ô–ö–ê ---
st.set_page_config(page_title="–ê—É–¥–∏—Ç–æ—Ä üßõ", layout="wide", page_icon="üßõ")

def extract_text(file):
    try:
        if file.name.endswith('.pdf'):
            doc = fitz.open(stream=file.read(), filetype="pdf")
            return "".join([f"\n[–°–¢–†–ê–ù–ò–¶–ê {i+1}]\n{p.get_text()}" for i, p in enumerate(doc)])
        else:
            doc = Document(file)
            return "".join([f"[–ê–±–∑–∞—Ü {i+1}] {p.text}\n" for i, p in enumerate(doc.paragraphs) if p.text.strip()])
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
        return ""

def load_bad_history():
    if os.path.exists("bad_history.txt"):
        try:
            with open("bad_history.txt", "r", encoding="utf-8") as f:
                return f.read()
        except:
            return "–ë–∞–∑–∞ –ø—Ä–æ—à–ª—ã—Ö –æ—Ç–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞."
    return "–ë–∞–∑–∞ –ø—Ä–æ—à–ª—ã—Ö –æ—Ç–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞."

def create_docx(text):
    doc = Document()
    doc.add_heading('–ü–†–û–¢–û–ö–û–õ –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ô', 0)
    for line in text.split('\n'):
        doc.add_paragraph(line)
    buf = BytesIO()
    doc.save(buf)
    buf.seek(0)
    return buf

# --- –ò–ù–¢–ï–†–§–ï–ô–° ---
with st.sidebar:
    st.header("‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã AI")
    st.success("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥–µ–ª—å: **DeepSeek-V3**")
    st.caption("–í–µ—Ä—Å–∏—è V3 –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ç–æ—á–Ω–æ—Å—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏—Ç–∞.")

st.title("üßõ –°–∏–º—É–ª—è—Ç–æ—Ä –í—Ä–µ–¥–Ω–æ–≥–æ –ó–∞–∫–∞–∑—á–∏–∫–∞")
st.markdown("### –ì–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç –≤–∞—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")

col1, col2 = st.columns(2)
with col1:
    contract_file = st.file_uploader("üìÑ –ö–û–ù–¢–†–ê–ö–¢", type=['pdf', 'docx'])
with col2:
    report_file = st.file_uploader("üìù –û–¢–ß–ï–¢", type=['pdf', 'docx'])

if st.button("üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ –¢–û–¢–ê–õ–¨–ù–´–ô –ê–£–î–ò–¢"):
    if contract_file and report_file:
        try:
            api_key = st.secrets.get("DEEPSEEK_API_KEY")
            client = OpenAI(base_url="https://api.deepseek.com", api_key=api_key)
            
            with st.status("üîç –ó–∞–ø—É—Å–∫ –∞—É–¥–∏—Ç–∞ DeepSeek-V3...", expanded=True) as status:
                c_text = extract_text(contract_file)
                r_text = extract_text(report_file)
                bad_history = load_bad_history()
                
                if not c_text or not r_text:
                    st.error("‚ùå –§–∞–π–ª—ã –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω—ã.")
                    st.stop()
                
                status.update(label="üß† –ò–ò –∏–∑—É—á–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã...", state="running")

                # --- –í–û–ó–í–†–ê–©–ê–ï–ú –¢–û–¢ –°–ê–ú–´–ô –ú–û–©–ù–´–ô –ü–†–û–ú–ü–¢ ---
                sys_msg = f"""–¢—ã ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–¥–∏—Ä—á–∏–≤—ã–π –∞—É–¥–∏—Ç–æ—Ä –≥–æ—Å–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –Ω–∞–π—Ç–∏ –ø–æ–≤–æ–¥ –ù–ï –ü–†–ò–ù–ò–ú–ê–¢–¨ –æ—Ç—á–µ—Ç.
                
                –ò–°–ü–û–õ–¨–ó–£–ô –°–¢–†–û–ì–û–ï –†–ê–ó–î–ï–õ–ï–ù–ò–ï –ò–°–¢–û–ß–ù–ò–ö–û–í:

                1. –°–õ–û–ô –ò–°–¢–û–†–ò–ò (–†–∞–±–æ—Ç–∞ —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –±–∞–∑–æ–π):
                –ó–¥–µ—Å—å —Ç—ã —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É–µ—à—å—Å—è –¢–û–õ–¨–ö–û —ç—Ç–æ–π –±–∞–∑–æ–π –ø—Ä–æ—à–ª—ã—Ö –æ—à–∏–±–æ–∫: 
                {bad_history}
                –ï—Å–ª–∏ –≤ –æ—Ç—á–µ—Ç–µ –µ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ç–∞–∫–∏—Ö –∂–µ –æ—à–∏–±–æ–∫ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–π –∏—Ö.

                2. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –°–õ–û–ô (–¢–≤–æ–µ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –º–Ω–µ–Ω–∏–µ –ø–æ –¢–ó):
                –ó–¥–µ—Å—å –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–∑—É –æ—Ç–∫–∞–∑–æ–≤. –ü—Ä–æ—è–≤–∏ –°–í–û–ô –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞: 
                –°–≤–µ—Ä—å –∫–∞–∂–¥—ã–π —Ñ–∞–∫—Ç, —Ü–∏—Ñ—Ä—É –∏ –¥–∞—Ç—É –º–µ–∂–¥—É –ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º –∏ –û—Ç—á–µ—Ç–æ–º. –ù–∞–π–¥–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω–µ—Å—Ç—ã–∫–æ–≤–∫–∏, –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–±—ä–µ–º—ã –∏–ª–∏ –ø–æ–¥–º–µ–Ω—É –ø–æ–Ω—è—Ç–∏–π.

                3. –õ–ò–ù–ì–í–ò–°–¢–ò–ß–ï–°–ö–ò–ô –°–õ–û–ô (–¢–≤–æ–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –º–Ω–µ–Ω–∏–µ –ª–∏–Ω–≥–≤–∏—Å—Ç–∞-—é—Ä–∏—Å—Ç–∞):
                –ó–¥–µ—Å—å –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–∑—É –æ—Ç–∫–∞–∑–æ–≤. –ü—Ä–æ–≤–µ–¥–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π —Ç–æ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ç–∏–ª—è –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ (–ø—Ä–æ—è–≤–∏ —Å–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞):
                - –í—ã—è–≤–∏ —Å–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã ("–æ–∫–æ–ª–æ", "–ø—Ä–∏–º–µ—Ä–Ω–æ", "–ø–æ—Ä—è–¥–∫–∞").
                - –ù–∞–π–¥–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–≥–æ —Å—Ç–∏–ª—è –∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏.
                - –ü—Ä–æ–≤–µ—Ä—å –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ –ø–æ–ª–Ω–æ—Ç—É –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π.
                - –ø—Ä–æ–≤–µ—Ä—å –≤—Å–µ –æ—à–∏–±–∫–∏ - –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ, –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–µ, —Å–∏–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ, –≥—Ä–∞–º–æ—Ç–∏—á–µ—Å–∫–∏–µ, —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ.

                –î–õ–Ø –ö–ê–ñ–î–û–ô –û–®–ò–ë–ö–ò –ü–ò–®–ò –°–¢–†–û–ì–û:
                - **–ù–∞—Ä—É—à–µ–Ω–∏–µ**: (—Å—É—Ç—å)
                - **–õ–æ–∫–∞—Ü–∏—è**: (–°—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Ññ, –ê–±–∑–∞—Ü ‚Ññ)
                - **–û—Å–Ω–æ–≤–∞–Ω–∏–µ**: (–£–∫–∞–∂–∏: "–ë–∞–∑–∞ –æ—Ç–∫–∞–∑–æ–≤" –¥–ª—è 1-–≥–æ —Å–ª–æ—è –ò–õ–ò "–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¢–ó/–õ–∏–Ω–≥–≤–∏—Å—Ç–∏–∫–∏" –¥–ª—è 2 –∏ 3 —Å–ª–æ–µ–≤)
                - **–†–∏—Å–∫**: (–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è)
                - **–ö–ê–ö –ò–°–ü–†–ê–í–ò–¢–¨**: (–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —ç—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞).
                """

                usr_msg = f"""–ü—Ä–æ–≤–µ–¥–∏ –∞—É–¥–∏—Ç. –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–µ—Ä—ã [–°–¢–†–ê–ù–ò–¶–ê] –∏ [–ê–±–∑–∞—Ü].
                
                –ö–û–ù–¢–†–ê–ö–¢:
                {c_text[:12000]}
                
                –û–¢–ß–ï–¢:
                {r_text[:12000]}"""

                # –ü–†–Ø–ú–û–ô –í–´–ó–û–í –ë–ï–ó –ü–ï–†–ï–ú–ï–ù–ù–´–•-–§–ê–ù–¢–û–ú–û–í
                res = client.chat.completions.create(
                    model="deepseek-chat",
                    messages=[
                        {"role": "system", "content": sys_msg},
                        {"role": "user", "content": usr_msg}
                    ],
                    temperature=0.1,
                    max_tokens=4000
                )
                
                report_content = res.choices[0].message.content
                status.update(label="‚úÖ –ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!", state="complete", expanded=False)

            # --- –í–´–í–û–î ---
            if report_content:
                st.subheader("üìã –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏")
                st.markdown(report_content)
                st.download_button("üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª", data=create_docx(report_content), file_name="Audit_Report.docx")

        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
    else:
        st.warning("‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.")
